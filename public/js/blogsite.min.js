(function(){angular.module("blogsiteApp",["ngRoute","ui.bootstrap"]);function e(e,r){e.when("/",{templateUrl:"userhome/userhome.view.html",controller:"userhomeCtrl",controllerAs:"vm"}).when("/blog",{templateUrl:"blog/bloglist.view.html",controller:"bloglistCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"userhome/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"userhome/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/user/edit",{templateUrl:"userhome/userEdit.view.html",controller:"userEditCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});r.html5Mode(true)}var r=function(){var e=this;e.linkname="angular test"};var t=function(e){var r=this;r.popupLoginForm=function(){alert("Let' log on")}};var o=function(){var e=this;e.modifiedOn=new Date};angular.module("blogsiteApp").config(["$routeProvider","$locationProvider",e]).controller("indexCtrl",r).controller("navibarCtrl",t).controller("bloglistCtrl",o)})();(function(){angular.module("blogsiteApp").controller("userhomeCtrl",e);e.$inject=["$scope","$location","blogsiteData","authentication"];function e(e,r,t,o){var n=this;if(o.isLoggedIn()){a()}else{r.path("/login")}function a(){t.getUserinfo().success(function(r){n.message=r?"":"No user found";n.user=r;e.navvm.currentUser.name=r.name}).error(function(e){n.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("registerCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,t){var o=this;o.user={};o.check="";o.returnPage=r.search().page||"/";o.emailChanged=function(){o.check="";console.log("changed")};o.checkEmail=function(){o.check=base64.decode("5ZGo56eL5LqR");console.log(o.check)};o.submit=function(){o.message="";if(e.registerForm.$pristine){o.message="Please fill the form first before you submit";return}if(e.registerForm.$invalid){o.message="There are errors in the form ,please correct them";return}if(!o.user.password1||o.user.password1!==o.user.password2){o.message="not valid password or two passwords not equal";return}o.user.password=o.user.password1;n(o.user)};function n(e){t.register(e).error(function(e){o.message="Sorry, something's gone wrong, please register again later";return false}).then(function(){r.search("page",null);r.path(o.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("loginCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,t){var o=this;o.credentials={email:"",password:""};o.returnPage=r.search().page||"/";o.submit=function(){o.message="";if(e.loginForm.$pristine){o.message="Please fill the form first before you submit";return false}if(!o.credentials.email||!o.credentials.password){o.message="All fields required, please try again";return false}if(e.loginForm.$invalid){o.message="There are errors in the form ,please correct them";return false}o.doLogin()};o.doLogin=function(){o.message="";t.login(o.credentials).error(function(e){o.message=e}).then(function(){r.search("page",null);r.path(o.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("userEditCtrl",e);e.$inject=["$scope","$location","$modal","blogsiteData","authentication"];function e(e,r,t,o,n){var a=this;a.returnPage=r.search().page||"/";a.years=[];a.months=[];a.days=[];a.years.push("年");a.months.push("月");a.days.push("日");for(var s=1929;s<=2050;s++){a.years.push(s)}for(s=1;s<=12;s++){a.months.push(s)}for(s=1;s<=31;s++){a.days.push(s)}if(n.isLoggedIn()){i()}else{r.path("/")}a.message="";a.submit=function(){if(a.year!=="年"&&a.month!=="月"&&a.day!=="日"){a.user.birthday=new Date(a.year+(a.month<10?"-0":"-")+a.month+(a.day<10?"-0":"-")+a.day);console.log(a.user.birthday)}o.updateUserinfo(a.user).error(function(e){a.message="modify failed";console.log(e);return false}).then(function(){r.search("page",null);r.path(a.returnPage)})};a.year="年";a.month="月";a.day="日";a.popPwdChgForm=function(){var e=t.open({templateUrl:"/userhome/passwordModal.view.html",controller:"passwordModalCtrl as vm"})};function i(){o.getUserinfo().success(function(r){a.message=r?"":"No user found";a.user=r;if(a.user.birthday){var t=new Date(a.user.birthday.toLocaleString().substr(0,10));a.year=t.getFullYear();a.month=t.getMonth()+1;a.day=t.getDate()}e.navvm.currentUser.name=r.name}).error(function(e){a.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("passwordModalCtrl",e);e.$inject=["$modalInstance","blogsiteData","authentication"];function e(e,r,t){var o=this;o.formError="";if(t.isLoggedIn()){n()}else{$location.path("/")}o.message="";o.modal={cancel:function(){e.dismiss("cancel")}};o.submit=function(){o.formError="submit"};function n(){r.getUserinfo().success(function(e){o.message=e?"":"No user found";o.user=e}).error(function(e){o.formError="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,r){var t=function(e){r.localStorage["blogsite-token"]=e};var o=function(){return r.localStorage["blogsite-token"]};var n=function(){var e=o();if(e){var t=JSON.parse(r.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}else{return false}};var a=function(){if(n()){var e=o();var t=JSON.parse(r.atob(e.split(".")[1]));return{email:t.email,name:base64.decode(t.name)}}};register=function(r){return e.post("/api/register",r).success(function(e){t(e.token)})};login=function(r){return e.post("/api/login",r).success(function(e){t(e.token)})};logout=function(){r.localStorage.removeItem("blogsite-token")};return{currentUser:a,saveToken:t,getToken:o,isLoggedIn:n,register:register,login:login,logout:logout}}})();(function(){angular.module("blogsiteApp").service("blogsiteData",e);e.$inject=["$http","authentication"];function e(e,r){var t=function(){var t=r.currentUser();return e.get("/api/user/"+t.email,{headers:{Authorization:"Bearer "+r.getToken()}})};var o=function(t){console.log(t);return e.put("/api/user/"+t.email,t,{headers:{Authorization:"Bearer "+r.getToken()}})};return{getUserinfo:t,updateUserinfo:o}}})();(function(){angular.module("blogsiteApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("blogsiteApp").controller("navigationCtrl",e);e.$inject=["$location","authentication"];function e(e,r){var t=this;t.currentPath=e.path();t.isLoggedIn=r.isLoggedIn();t.currentUser=r.currentUser();t.logout=function(){r.logout();e.path("/")}}})();