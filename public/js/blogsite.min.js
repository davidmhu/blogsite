(function(){angular.module("blogsiteApp",["ngRoute","ui.bootstrap","angularFileUpload"]);function e(e,r){e.when("/",{templateUrl:"userhome/userhome.view.html",controller:"userhomeCtrl",controllerAs:"vm"}).when("/blog",{templateUrl:"blog/bloglist.view.html",controller:"bloglistCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"userhome/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"userhome/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/user/edit",{templateUrl:"userhome/userEdit.view.html",controller:"userEditCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});r.html5Mode(true)}var r=function(){var e=this;e.linkname="angular test"};var o=function(e){var r=this;r.popupLoginForm=function(){alert("Let' log on")}};var n=function(){var e=this;e.modifiedOn=new Date};angular.module("blogsiteApp").config(["$routeProvider","$locationProvider",e]).controller("navibarCtrl",o).controller("bloglistCtrl",n)})();(function(){angular.module("blogsiteApp").controller("userhomeCtrl",e);e.$inject=["$scope","$location","blogsiteData","authentication"];function e(e,r,o,n){console.log("in home");var t=this;if(n.isLoggedIn()){s()}else{r.path("/login")}function s(){o.getUserinfo().success(function(r){t.message=r?"":"No user found";t.user=r;e.navvm.currentUser.name=r.name}).error(function(e){t.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("registerCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,o){var n=this;n.user={};n.check="";n.returnPage=r.search().page||"/";n.emailChanged=function(){n.check="";console.log("changed")};n.checkEmail=function(){n.check=base64.decode("5ZGo56eL5LqR");console.log(n.check)};n.submit=function(){n.message="";if(e.registerForm.$pristine){n.message="Please fill the form first before you submit";return}if(e.registerForm.$invalid){n.message="There are errors in the form ,please correct them";return}if(!n.user.password1||n.user.password1!==n.user.password2){n.message="not valid password or two passwords not equal";return}n.user.password=n.user.password1;t(n.user)};function t(e){o.register(e).error(function(e){n.message="Sorry, something's gone wrong, please register again later";return false}).then(function(){r.search("page",null);r.path(n.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("loginCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,o){var n=this;n.credentials={email:"",password:""};n.returnPage=r.search().page||"/";n.submit=function(){n.message="";if(e.loginForm.$pristine){n.message="Please fill the form first before you submit";return false}if(!n.credentials.email||!n.credentials.password){n.message="All fields required, please try again";return false}if(e.loginForm.$invalid){n.message="There are errors in the form ,please correct them";return false}n.doLogin()};n.doLogin=function(){n.message="";o.login(n.credentials).error(function(e){n.message=e.message}).then(function(){r.search("page",null);r.path(n.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("userEditCtrl",e);e.$inject=["$scope","$location","$modal","blogsiteData","authentication"];function e(e,r,o,n,t){var s=this;s.returnPage=r.search().page||"/";s.years=[];s.months=[];s.days=[];s.years.push("年");s.months.push("月");s.days.push("日");for(var a=1929;a<=2050;a++){s.years.push(a)}for(a=1;a<=12;a++){s.months.push(a)}for(a=1;a<=31;a++){s.days.push(a)}if(t.isLoggedIn()){i()}else{r.path("/")}s.message="";s.submit=function(){if(s.year!=="年"&&s.month!=="月"&&s.day!=="日"){s.user.birthday=new Date(s.year+(s.month<10?"-0":"-")+s.month+(s.day<10?"-0":"-")+s.day);console.log(s.user.birthday)}n.updateUserinfo(s.user).error(function(e){s.message="modify failed";console.log(e);return false}).then(function(){r.search("page",null);r.path(s.returnPage)})};s.year="年";s.month="月";s.day="日";s.popPwdChgForm=function(){var e=o.open({templateUrl:"/userhome/passwordModal.view.html",controller:"passwordModalCtrl as vm"})};s.popImgUploadForm=function(){var e=o.open({templateUrl:"/common/picUploadModal.view.html",controller:"picUploadModalCtrl as vm"})};function i(){n.getUserinfo().success(function(r){s.message=r?"":"No user found";s.user=r;if(s.user.birthday){var o=new Date(s.user.birthday.toLocaleString().substr(0,10));s.year=o.getFullYear();s.month=o.getMonth()+1;s.day=o.getDate()}e.navvm.currentUser.name=r.name}).error(function(e){s.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("passwordModalCtrl",e);e.$inject=["$modalInstance","blogsiteData","authentication"];function e(e,r,o){var n=this;n.formError="";if(o.isLoggedIn()){t()}else{$location.path("/")}n.message="";n.modal={cancel:function(){e.dismiss("cancel")}};n.onSubmit=function(){if(!n.user.oldpassword){n.formError="old password is needed.";return false}if(!n.user.password1||!n.user.password2||n.user.password1!==n.user.password2){n.formError="two new password are both needed and should be equal.";return false}n.formError="submiting...";var e={email:n.user.email,oldpassword:n.user.oldpassword,newpassword:n.user.password1};r.changePwd(e).success(function(){n.formError="changed pwd successfully";n.user.oldpassword="";n.user.password1="";n.user.password2="";e={}}).error(function(e){n.formError="Sorry, something's gone wrong:"+e.message})};function t(){r.getUserinfo().success(function(e){n.message=e?"":"No user found";n.user=e}).error(function(e){n.formError="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("picUploadModalCtrl",e);e.$inject=["$modalInstance","$scope","FileUploader","blogsiteData","authentication"];function e(e,r,o,n,t){var s=this;s.formError="";s.message="";s.imgfile="";s.modal={cancel:function(){e.dismiss("cancel")}};s.fileChange=function(){console.log(s.file);n.imgUpload("sieie@kdod.com",s.file).success(function(e){s.formError="changed pwd successfully";s.imgfile=e.path}).error(function(e){s.formError="Sorry, something's gone wrong:"})};var a=r.uploader=new o;a.filters.push({name:"imageFilter",fn:function(e,r){var o="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(o)!==-1}});s.onSubmit=function(){var e;s.formError="uploading..."}}})();(function(){angular.module("blogsiteApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,r){var o=function(e){r.localStorage["blogsite-token"]=e};var n=function(){return r.localStorage["blogsite-token"]};var t=function(){var e=n();if(e){var o=JSON.parse(r.atob(e.split(".")[1]));return o.exp>Date.now()/1e3}else{return false}};var s=function(){if(t()){var e=n();var o=JSON.parse(r.atob(e.split(".")[1]));return{email:o.email,name:base64.decode(o.name)}}};register=function(r){return e.post("/api/register",r).success(function(e){o(e.token)})};login=function(r){return e.post("/api/login",r).success(function(e){o(e.token)})};logout=function(){r.localStorage.removeItem("blogsite-token")};return{currentUser:s,saveToken:o,getToken:n,isLoggedIn:t,register:register,login:login,logout:logout}}})();(function(){angular.module("blogsiteApp").service("blogsiteData",e);e.$inject=["$http","authentication"];function e(e,r){var o=function(){var o=r.currentUser();return e.get("/api/user/"+o.email,{headers:{Authorization:"Bearer "+r.getToken()}})};var n=function(o){return e.put("/api/user/"+o.email,o,{headers:{Authorization:"Bearer "+r.getToken()}})};var t=function(o){return e.post("/api/user/changepwd/"+o.email,o,{headers:{Authorization:"Bearer "+r.getToken()}}).success(function(e){r.saveToken(e)})};var s=function(r,o){return e.post("/api/user/uploads/"+r,o,{headers:{"Content-Type":"file"},file:o})};return{getUserinfo:o,updateUserinfo:n,changePwd:t,imgUpload:s}}})();(function(){angular.module("blogsiteApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("blogsiteApp").controller("navigationCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,o){var n=this;n.currentPath=r.path();n.isLoggedIn=o.isLoggedIn();n.currentUser=o.currentUser();n.logout=function(){o.logout();r.path("/")}}})();