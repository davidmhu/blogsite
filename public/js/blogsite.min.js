(function(){angular.module("blogsiteApp",["ngRoute","ui.bootstrap","angularFileUpload","ng.ueditor","ngSanitize"]);function e(e,r){e.when("/",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/blog/new",{templateUrl:"blog/blog.article.edit.html",controller:"articleEditCtrl",controllerAs:"vm"}).when("/blog/:blogid",{templateUrl:"blog/blog.article.view.html",controller:"articleViewCtrl",controllerAs:"vm"}).when("/blog/edit/:blogid",{templateUrl:"blog/blog.article.edit.html",controller:"articleEditCtrl",controllerAs:"vm"}).when("/blog/author/:email",{templateUrl:"home/home.view.html",controller:"homeCtrl",controllerAs:"vm"}).when("/blog",{templateUrl:"blog/bloglist.view.html",controller:"bloglistCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"userhome/login.view.html",controller:"loginCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"userhome/register.view.html",controller:"registerCtrl",controllerAs:"vm"}).when("/user/edit",{templateUrl:"userhome/userEdit.view.html",controller:"userEditCtrl",controllerAs:"vm"}).when("/user/list",{templateUrl:"userhome/userList.view.html",controller:"userlistCtrl",controllerAs:"vm"}).when("/user/view/:email",{templateUrl:"userhome/userhome.view.html",controller:"userhomeCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"});r.html5Mode(true)}angular.module("blogsiteApp").config(["$routeProvider","$locationProvider",e])})();(function(){angular.module("blogsiteApp").controller("homeCtrl",e);e.$inject=["$scope","$location","$routeParams","blogsiteData"];function e(e,r,t,o){var n=this,i="";n.bloglist={};if(t.hasOwnProperty("email")){i="?userEmail="+t.email}o.getBlogList(i).success(function(e){n.message=e?"":"No user found";n.bloglist=e;console.log(n.bloglist.length)}).error(function(e){n.message="Sorry, something's gone wrong, please try again later"})}})();(function(){angular.module("blogsiteApp").controller("articleViewCtrl",e);e.$inject=["$scope","$location","authentication","$routeParams","blogsiteData"];function e(e,r,t,o,n){var i=this,a="";i.article={};i.isLoggedIn=t.isLoggedIn();i.currentUser=t.currentUser();if(!o.hasOwnProperty("blogid")||o.blogid==="new"){return}i.blogid=o.blogid;i.delBlog=function(){if(!i.blogid){return}var e=confirm("Are you sure to erase this blog?");if(e){n.deleteBlog(i.blogid).success(function(e){r.path("/")}).error(function(e){alert("save blog failed")})}else{return}};var s=function(e){n.getBlogDetail(e).success(function(e){i.message=e?"":"No user found";i.article=e}).error(function(e){i.message="Sorry, something's gone wrong, get blog info failed,please try again later"})};s(i.blogid)}})();(function(){angular.module("blogsiteApp").controller("articleEditCtrl",e);e.$inject=["$scope","$location","authentication","$routeParams","blogsiteData"];function e(e,r,t,o,n){var i=this,a,s="";i.article={};i.isLoggedIn=t.isLoggedIn();i.currentUser=t.currentUser();i.config={toolbars:[["fullscreen","source","|","undo","redo","|","bold","italic","underline","fontborder","strikethrough","superscript","subscript","removeformat","formatmatch","autotypeset","blockquote","pasteplain","|","forecolor","backcolor","insertorderedlist","insertunorderedlist","selectall","cleardoc","|","rowspacingtop","rowspacingbottom","lineheight","|","customstyle","paragraph","fontfamily","fontsize","|","directionalityltr","directionalityrtl","indent","|","justifyleft","justifycenter","justifyright","justifyjustify","|","touppercase","tolowercase","|","link","unlink","anchor","|","imagenone","imageleft","imageright","imagecenter","|","simpleupload","insertimage","emotion","scrawl","pagebreak","template","background","|","horizontal","date","time","spechars","snapscreen","wordimage","|","inserttable","deletetable","insertparagraphbeforetable","insertrow","deleterow","insertcol","deletecol","mergecells","mergeright","mergedown","splittocells","splittorows","splittocols","charts","|","searchreplace","help","drafts"]],autoHeightEnabled:true};i.ready=function(e){a=e};i.blogid=o.hasOwnProperty("blogid")?o.blogid:"";i.delBlog=function(){if(!i.blogid){return}var e=confirm("Are you sure to erase this blog?");if(e){n.deleteBlog(i.blogid).success(function(e){r.path("/")}).error(function(e){alert("save blog failed")})}else{return}};i.saveBlog=function(){var e=a.getContentTxt();if(!i.article.title||!i.article.content){alert("title and content should not be empty");return}var t={userEmail:i.currentUser.email,userName:i.currentUser.name,title:i.article.title,content:i.article.content,category:"Movie|Tech"};t.brief=e?e.substr(0,50):i.article.content.substr(0,50);if(i.blogid){n.updateBlog(i.blogid,t).success(function(e){r.path("/blog/"+e._id)}).error(function(e){alert("save blog failed")})}else{n.saveBlog(t).success(function(e){r.path("/blog/"+e._id)}).error(function(e){alert("save blog failed")})}};var l=function(e){n.getBlogDetail(e).success(function(e){i.message=e?"":"No user found";i.article=e;if(i.article.userEmail!==i.currentUser.email){alert("You have no edit authority");r.path("/blog/"+e._id)}}).error(function(e){i.message="Sorry, something's gone wrong, get blog info failed,please try again later"})};if(i.blogid){l(i.blogid)}}})();(function(){angular.module("blogsiteApp").controller("userhomeCtrl",e);e.$inject=["$scope","$location","$routeParams","blogsiteData","authentication"];function e(e,r,t,o,n){var i=this,a;if(n.isLoggedIn()){if(t.hasOwnProperty("email")){a=t.email}else{a=n.currentUser().email}s(a)}else{r.path("/login")}function s(r){o.getUserinfo(r).success(function(r){i.message=r?"":"No user found";i.user=r;e.navvm.currentUser.name=r.name}).error(function(e){i.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("registerCtrl",e);e.$inject=["$scope","$location","authentication","blogsiteData"];function e(e,r,t,o){var n=this;n.user={};n.check="";n.returnPage=r.search().page||"/";n.emailChanged=function(){n.check=""};n.checkEmail=function(){n.check="X";o.checkEmail(n.user.email).success(function(e){if(!e.email){n.check="√"}})};n.submit=function(){n.message="";if(e.registerForm.$pristine){n.message="Please fill the form first before you submit";return}if(e.registerForm.$invalid){n.message="There are errors in the form ,please correct them";return}if(!n.user.password1||n.user.password1!==n.user.password2){n.message="not valid password or two passwords not equal";return}n.user.password=n.user.password1;i(n.user)};function i(e){t.register(e).error(function(e){n.message="Sorry, something's gone wrong, please register again later";return false}).then(function(){r.search("page",null);r.path(n.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("loginCtrl",e);e.$inject=["$scope","$location","authentication"];function e(e,r,t){var o=this;o.credentials={email:"",password:""};o.returnPage=r.search().page||"/#";o.submit=function(){o.message="";if(e.loginForm.$pristine){o.message="Please fill the form first before you submit";return false}if(!o.credentials.email||!o.credentials.password){o.message="All fields required, please try again";return false}if(e.loginForm.$invalid){o.message="There are errors in the form ,please correct them";return false}o.doLogin()};o.doLogin=function(){o.message="";t.login(o.credentials).error(function(e){o.message=e.message}).then(function(){r.search("page",null);r.path(o.returnPage)})}}})();(function(){angular.module("blogsiteApp").controller("userEditCtrl",e);e.$inject=["$scope","$location","$modal","blogsiteData","authentication"];function e(e,r,t,o,n){var i=this;i.returnPage=r.search().page||"/";i.years=[];i.months=[];i.days=[];i.years.push("年");i.months.push("月");i.days.push("日");for(var a=1929;a<=2050;a++){i.years.push(a)}for(a=1;a<=12;a++){i.months.push(a)}for(a=1;a<=31;a++){i.days.push(a)}if(n.isLoggedIn()){s()}else{r.path("/")}i.message="";i.submit=function(){if(i.year!=="年"&&i.month!=="月"&&i.day!=="日"){i.user.birthday=new Date(i.year+(i.month<10?"-0":"-")+i.month+(i.day<10?"-0":"-")+i.day);console.log(i.user.birthday)}o.updateUserinfo(i.user).error(function(e){i.message="modify failed";console.log(e);return false}).then(function(){r.search("page",null);r.path(i.returnPage)})};i.year="年";i.month="月";i.day="日";i.popPwdChgForm=function(){var e=t.open({templateUrl:"/userhome/passwordModal.view.html",controller:"passwordModalCtrl as vm"})};i.popImgUploadForm=function(){var e=t.open({templateUrl:"/common/picUploadModal.view.html",controller:"picUploadModalCtrl as vm",resolve:{userData:function(){return{email:i.user.email,name:i.user.name,protrait:i.user.portrait}}}});e.result.then(function(e){i.user.portrait=e})};function s(){var r=n.currentUser().email;o.getUserinfo(r).success(function(r){i.message=r?"":"No user found";i.user=r;if(i.user.birthday){var t=new Date(i.user.birthday.toLocaleString().substr(0,10));i.year=t.getFullYear();i.month=t.getMonth()+1;i.day=t.getDate()}e.navvm.currentUser.name=r.name}).error(function(e){i.message="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("userlistCtrl",e);e.$inject=["$scope","blogsiteData","authentication"];function e(e,r,t){var o=this;o={curpage:1,showFilter:false,showSort:false,pagesize:8,queryCond:{},rowcnt:0,pagecnt:1,pageArr:[],querytxt:"",orderby:"email",filterby:"name",isasc:1,message:"",topage:function(e){o.message="";if(e>=1&&e<=o.pagecnt){n(e)}},queryFilter:function(){o.queryCond.fuzzyname=false;delete o.queryCond.name;o.queryCond.fuzzyemail=false;delete o.queryCond.email;if(o.querytxt){if(o.filterby=="name"){o.queryCond.fuzzyname=true;o.queryCond.name=o.querytxt}if(o.filterby=="email"){o.queryCond.fuzzyemail=true;o.queryCond.email=o.querytxt}}n(1)}};var n=function(t){var n={};if(o.orderby=="email"){if(o.isasc==1){n={email:1}}else{n={email:-1}}}if(o.orderby=="name"){if(o.isasc==1){n={name:1}}else{n={name:-1}}}if(o.orderby=="createDate"){if(o.isasc==1){n={createdOn:1}}else{n={createdOn:-1}}}r.getListpage(t,o.pagesize,o.queryCond,n).success(function(r){if(r.rowcnt){o.userlist=r.userlist;o.rowcnt=r.rowcnt;o.pagecnt=Math.ceil(o.rowcnt/o.pagesize);o.curpage=t;o.pageArr=i(o.pagecnt,o.curpage);o.message=""}else{o.message="Sorry,no corespondent users found";o.userlist={};o.rowcnt=o.pagecnt=0;o.curpage=1;o.pageArr=[]}e.vm=o}).error(function(r){o.message="Sorry, something's gone wrong: "+r.message;o.userlist={};o.rowcnt=o.pagecnt=0;o.curpage=1;o.pageArr=[];e.vm=o})};n(1);var i=function(e,r){var t=[],o=1,n=e;if(r<1||r>e||e<1)return t;if(e>5){if(r<=3){n=5}else{o=r-2;n=Math.min(e,r+2)}if(n-o<4&&n>5){o=n-4}}for(var i=o;i<=n;i++){t.push(i)}return t}}})();(function(){angular.module("blogsiteApp").controller("passwordModalCtrl",e);e.$inject=["$modalInstance","blogsiteData","authentication"];function e(e,r,t){var o=this;o.formError="";if(t.isLoggedIn()){n()}else{$location.path("/")}o.message="";o.modal={cancel:function(){e.dismiss("cancel")}};o.onSubmit=function(){if(!o.user.oldpassword){o.formError="old password is needed.";return false}if(!o.user.password1||!o.user.password2||o.user.password1!==o.user.password2){o.formError="two new password are both needed and should be equal.";return false}o.formError="submiting...";var e={email:o.user.email,oldpassword:o.user.oldpassword,newpassword:o.user.password1};r.changePwd(e).success(function(){o.formError="changed pwd successfully";o.user.oldpassword="";o.user.password1="";o.user.password2="";e={}}).error(function(e){o.formError="Sorry, something's gone wrong:"+e.message})};function n(){var e=t.currentUser().email;r.getUserinfo(e).success(function(e){o.message=e?"":"No user found";o.user=e}).error(function(e){o.formError="Sorry, something's gone wrong, please try again later"})}}})();(function(){angular.module("blogsiteApp").controller("picUploadModalCtrl",e);e.$inject=["$modalInstance","$scope","FileUploader","blogsiteData","authentication","userData"];function e(e,r,t,o,n,i){var a=this;a.user=i;a.formError="";a.message="";a.imgfile="";a.modal={cancel:function(){e.dismiss("cancel")},close:function(r){e.close(r)}};var s=r.uploader=new t({url:"/api/user/uploads"});s.onSuccessItem=function(e,r,t,o){a.imgfile=r.path;a.formError="upload completed."};s.onErrorItem=function(e,r,t,o){if(r.message){a.formError="Sorry,upload failed, due to "+r.message+", please try again later"}else{a.formError="Sorry,upload failed,  please try again later"}};s.filters.push({name:"imageFilter",fn:function(e,r){var t="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(t)!==-1}});s.onAfterAddingFile=function(e){if(s.queue.length>1){s.queue.shift()}};a.changePortrait=function(){o.changePortrait(a.user.email,a.imgfile).success(function(e){a.imgfile=e.portrait;a.formError="well done";a.modal.close(a.imgfile)}).error(function(e){a.formError=e.message})}}})();(function(){angular.module("blogsiteApp").service("authentication",e);e.$inject=["$http","$window"];function e(e,r){var t=function(e){r.localStorage["blogsite-token"]=e};var o=function(){return r.localStorage["blogsite-token"]};var n=function(){var e=o();if(e){var t=JSON.parse(r.atob(e.split(".")[1]));return t.exp>Date.now()/1e3}else{return false}};var i=function(){if(n()){var e=o();var t=JSON.parse(r.atob(e.split(".")[1]));return{email:t.email,name:base64.decode(t.name)}}};register=function(r){return e.post("/api/register",r).success(function(e){t(e.token)})};login=function(r){return e.post("/api/login",r).success(function(e){t(e.token)})};logout=function(){r.localStorage.removeItem("blogsite-token")};return{currentUser:i,saveToken:t,getToken:o,isLoggedIn:n,register:register,login:login,logout:logout}}})();(function(){angular.module("blogsiteApp").service("blogsiteData",e);e.$inject=["$http","authentication"];function e(e,r){var t=function(t){return e.get("/api/user/"+t,{headers:{Authorization:"Bearer "+r.getToken()}})};var o=function(t){return e.put("/api/user/"+t.email,t,{headers:{Authorization:"Bearer "+r.getToken()}})};var n=function(t){return e.post("/api/user/changepwd/"+t.email,t,{headers:{Authorization:"Bearer "+r.getToken()}}).success(function(e){r.saveToken(e)})};var i=function(t,o){return e.post("/api/user/portrait/"+t,{filename:o},{headers:{Authorization:"Bearer "+r.getToken()}})};var a=function(r){return e.get("/api/user/emailcheck/"+r)};var s=function(t,o,n,i){var a={page:t,pagesize:o,queryCond:n,sortCond:i};return e.post("/api/user/list/",a,{headers:{Authorization:"Bearer "+r.getToken()}})};var l=function(r){return e.get("/api/blog/"+r)};var u=function(r){return e.get("/api/blog/"+r)};var c=function(t){return e.post("/api/blog/",t,{headers:{Authorization:"Bearer "+r.getToken()}})};var g=function(t,o){return e.put("/api/blog/"+t,o,{headers:{Authorization:"Bearer "+r.getToken()}})};var m=function(t){return e.delete("/api/blog/"+t,{headers:{Authorization:"Bearer "+r.getToken()}})};var f=function(t,o){return e.post("/api/comment/"+t,o,{headers:{Authorization:"Bearer "+r.getToken()}})};var d=function(t){return e.delete("/api/comment/"+t,{headers:{Authorization:"Bearer "+r.getToken()}})};var p=function(r){return e.get("/api/comment/blog/"+r)};return{getUserinfo:t,updateUserinfo:o,changePwd:n,changePortrait:i,checkEmail:a,getListpage:s,getBlogList:l,getBlogDetail:u,saveBlog:c,updateBlog:g,deleteBlog:m,saveComment:f,deleteComment:d,getCommentList:p}}})();(function(){angular.module("blogsiteApp").directive("navigation",e);function e(){return{restrict:"EA",templateUrl:"/common/navigation.template.html",controller:"navigationCtrl as navvm"}}})();(function(){angular.module("blogsiteApp").directive("comment",e);function e(){return{restrict:"EA",templateUrl:"/common/comment.template.html",controller:"commentCtrl as cmtVm",scope:{blogid:"=blogId"}}}})();(function(){angular.module("blogsiteApp").directive("commentedit",e);function e(){return{restrict:"EA",templateUrl:"/blog/commentEdit.template.html",controller:"commentEditCtrl as cmteditVm",scope:{blogid:"=blogId"}}}})();(function(){angular.module("blogsiteApp").directive("ngThumb",["$window",function(e){var r={support:!!(e.FileReader&&e.CanvasRenderingContext2D),isFile:function(r){return angular.isObject(r)&&r instanceof e.File},isImage:function(e){var r="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(r)!==-1}};return{restrict:"A",template:"<canvas/>",link:function(e,t,o){if(!r.support)return;var n=e.$eval(o.ngThumb);if(!r.isFile(n.file))return;if(!r.isImage(n.file))return;var i=t.find("canvas");var a=new FileReader;a.onload=s;a.readAsDataURL(n.file);function s(e){var r=new Image;r.onload=l;r.src=e.target.result}function l(){var e=n.width||this.width/this.height*n.height;var r=n.height||this.height/this.width*n.width;i.attr({width:e,height:r});i[0].getContext("2d").drawImage(this,0,0,e,r)}}}}])})();(function(){angular.module("blogsiteApp").controller("navigationCtrl",e);e.$inject=["$location","authentication"];function e(e,r){var t=this;t.test="123";t.isLoggedIn=r.isLoggedIn();t.currentUser=r.currentUser();t.logout=function(){r.logout();e.path("/#")};t.currentPath=e.path()}})();(function(){angular.module("blogsiteApp").controller("commentCtrl",e);e.$inject=["$scope","authentication","blogsiteData"];function e(e,r,t){var o=this;var n=o.blogid=e.blogid;o.comment="";o.reply="";o.isLoggedIn=r.isLoggedIn();o.currentUser=r.currentUser();console.log(o);var i=function(e,r){var t=[],o=[];e.forEach(function(e){t.push(e);o=r[e._id];if(o){t=t.concat(i(o,r))}});return t};o.showReply=function(e){o.replyForm=[];o.replyForm.push(e)};o.saveReply=function(e){a(e,o.reply)};o.saveComment=function(){a(0,o.comment)};var a=function(e,r){if(!r.trim()){alert("empty comment");return}if(r.length>255){alert("comment max length is 255");return}var i={parentId:e,comment:r};t.saveComment(n,i).success(function(e){o.message="comment saved successfully";o.comment="";o.reply="";o.replyForm=[];s(o.blogid)}).error(function(e){o.message="Sorry, something's gone wrong,save comment failed, please try again later"})};var s=function(e){var r=[],n=[],a=[],s;t.getCommentList(e).success(function(e){e.forEach(function(e){if(e.depth===0){r.push(e)}else{a=e.path.match(/([\d|\w]+)$/);s=a[0];if(s){if(!n[s]){n[s]=[]}n[s].push(e)}}});o.commentList=i(r,n)}).error(function(e){o.message="Sorry, something's gone wrong,get comment failed, please try again later"})};s(n)}})();(function(){angular.module("blogsiteApp").filter("formatTime",e);function e(){return function(e){var r=(new Date).valueOf();e=new Date(e).valueOf();if(e&&r<e+60*1e3){return"1 min ago"}else if(e&&r<e+60*10*1e3){return"10 min ago"}else if(e&&r<e+60*30*1e3){return"half an hour ago"}else if(e&&r<e+60*60*1e3){return"1 hour ago"}else if(e&&r<e+60*60*12*1e3){return"half day ago"}else if(e&&r<e+60*60*24*1e3){return"1 day ago"}else if(e&&r<e+60*60*24*2*1e3){return"2 days ago"}else if(e&&r<e+60*60*24*3*1e3){return"3 days ago"}else if(e){return new Date(e).toLocaleDateString()}}}})();(function(){angular.module("blogsiteApp").controller("commentEditCtrl",e);e.$inject=["$scope","authentication","blogsiteData"];function e(e,r,t){var o=this;var n=o.blogid=e.blogid;o.comment="";o.reply="";o.isLoggedIn=r.isLoggedIn();o.currentUser=r.currentUser();console.log(o);var i=function(e,r){var t=[],o=[];e.forEach(function(e){t.push(e);o=r[e._id];if(o){t=t.concat(i(o,r))}});return t};o.deleteCommentOrReply=function(e){var r=confirm("Are you sure to erase this comment and its replies?");if(!r){return}t.deleteComment(e).success(function(e){o.message="comment saved successfully";a(o.blogid)}).error(function(e){o.message="Sorry, something's gone wrong,save comment failed, please try again later"})};var a=function(e){var r=[],n=[],a=[],s;t.getCommentList(e).success(function(e){e.forEach(function(e){if(e.depth===0){r.push(e)}else{a=e.path.match(/([\d|\w]+)$/);s=a[0];if(s){if(!n[s]){n[s]=[]}n[s].push(e)}}});o.commentList=i(r,n)}).error(function(e){o.message="Sorry, something's gone wrong,get comment failed, please try again later"})};a(n)}})();